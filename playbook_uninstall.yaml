- name: "Deploy and configure XRay-core with ShadowSocks and VLESS-XTLS-uTLS-Reality service"
  hosts: all
  become: true
  become_method: ansible.builtin.sudo
  become_user: root

  tasks:

    - name: "Stop and disable service"
      ansible.builtin.systemd_service:
        name: "xray.service"
        state: "stopped"
        enabled: false
      failed_when: false

    - name: "Remove unit file"
      ansible.builtin.file:
        name: "/etc/systemd/system/xray.service"
        state: absent

    - name: "Reload systemd units"
      ansible.builtin.systemd_service:
        daemon_reexec: true
        daemon_reload: true

    - name: "Save config backup"
      ansible.builtin.fetch:
        src: "/opt/xray/config.json"
        dest: "JSON/{{ ansible_host }}_config.json"
        flat: true
      failed_when: false

    - name: "Remove service directory"
      ansible.builtin.file:
        name: "/opt/xray"
        state: absent
